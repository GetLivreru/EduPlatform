# Система ролей пользователей

## Обзор

Система ролей обеспечивает контроль доступа к различным функциям платформы на основе роли пользователя.

## Доступные роли

### 1. Student (Студент) - `"student"`
**По умолчанию для новых пользователей**

**Права доступа:**
- ✅ Просмотр доступных тестов
- ✅ Прохождение тестов
- ✅ Просмотр собственных результатов
- ✅ Получение рекомендаций по обучению
- ❌ Создание/редактирование тестов
- ❌ Просмотр результатов других пользователей
- ❌ Управление пользователями

### 2. Teacher (Преподаватель) - `"teacher"`

**Права доступа:**
- ✅ Все права студента
- ✅ Создание и редактирование тестов
- ✅ Просмотр результатов всех студентов
- ✅ Анализ статистики по тестам
- ❌ Управление пользователями
- ❌ Административные функции

### 3. Admin (Администратор) - `"admin"`

**Права доступа:**
- ✅ Все права преподавателя
- ✅ Создание, редактирование и удаление пользователей
- ✅ Назначение ролей пользователям
- ✅ Полный доступ к административным функциям
- ✅ Управление системой

## API Endpoints

### Управление ролями

#### Получить список доступных ролей
```http
GET /admin/roles
```

**Ответ:**
```json
{
  "roles": [
    {
      "value": "student",
      "label": "Студент",
      "description": "Обычный пользователь, может проходить тесты и просматривать материалы"
    },
    {
      "value": "teacher", 
      "label": "Преподаватель",
      "description": "Может создавать и редактировать тесты, просматривать результаты студентов"
    },
    {
      "value": "admin",
      "label": "Администратор", 
      "description": "Полные права доступа: управление пользователями, тестами и системой"
    }
  ]
}
```

#### Получить пользователей по роли
```http
GET /admin/users/by-role/{role}
```

**Параметры:**
- `role` - роль пользователей (`student`, `teacher`, `admin`)

**Ответ:**
```json
{
  "role": "teacher",
  "count": 5,
  "users": [
    {
      "id": "...",
      "name": "Преподаватель Иванов",
      "login": "teacher@example.com",
      "role": "teacher",
      "quiz_points": 0,
      "created_at": "2024-01-01T12:00:00"
    }
  ]
}
```

### Управление пользователями

#### Создать пользователя (только админ)
```http
POST /admin/users
```

**Тело запроса:**
```json
{
  "name": "Имя пользователя",
  "login": "user@example.com", 
  "password": "password123",
  "role": "student"
}
```

#### Обновить пользователя (только админ)
```http
PUT /admin/users/{user_id}
```

**Тело запроса:**
```json
{
  "name": "Новое имя",
  "role": "teacher"
}
```

### Аутентификация

#### Регистрация
```http
POST /api/register
```

**Тело запроса:**
```json
{
  "name": "Имя пользователя",
  "login": "user@example.com",
  "password": "password123",
  "role": "student"
}
```

**Примечание:** Роль по умолчанию - `student`

#### Вход в систему
```http
POST /api/login
```

**Ответ включает информацию о роли:**
```json
{
  "access_token": "...",
  "token_type": "bearer",
  "user": {
    "id": "...",
    "name": "Имя пользователя",
    "login": "user@example.com",
    "role": "student",
    "is_admin": false
  }
}
```

#### Профиль пользователя
```http
GET /api/profile
Authorization: Bearer {token}
```

**Ответ:**
```json
{
  "id": "...",
  "name": "Имя пользователя", 
  "login": "user@example.com",
  "role": "student",
  "quiz_points": 150,
  "created_at": "2024-01-01T12:00:00"
}
```

## Middleware и авторизация

### Доступные функции проверки

1. **`require_admin`** - требует роль администратора
2. **`require_teacher_or_admin`** - требует роль преподавателя или администратора  
3. **`require_role(role)`** - требует конкретную роль

### Пример использования

```python
from fastapi import Depends
from middleware import require_admin, require_teacher_or_admin, require_role, UserRole

# Только администраторы
@app.get("/admin/users", dependencies=[Depends(require_admin)])
async def get_users():
    pass

# Преподаватели и администраторы
@app.post("/quizzes", dependencies=[Depends(require_teacher_or_admin)])
async def create_quiz():
    pass

# Только преподаватели
@app.get("/teacher/dashboard", dependencies=[Depends(require_role(UserRole.teacher))])
async def teacher_dashboard():
    pass
```

## Миграция данных

### Обратная совместимость

Система автоматически обрабатывает старые учетные записи с полем `is_admin`:
- Пользователи с `is_admin: true` получают роль `admin`
- Остальные пользователи получают роль `student`

### Скрипт тестирования

Запустите скрипт для создания тестовых пользователей и миграции данных:

```bash
cd backend
python test_roles.py
```

Этот скрипт:
- Создает тестовых пользователей с разными ролями
- Мигрирует старых пользователей с `is_admin`
- Устанавливает роль по умолчанию для пользователей без роли
- Выводит статистику по ролям

## Безопасность

### Важные моменты

1. **Роли в токенах**: Роль пользователя проверяется при каждом запросе из базы данных, а не из токена
2. **Валидация ролей**: Все роли валидируются через enum `UserRole`
3. **Права доступа**: Каждый endpoint защищен соответствующими middleware
4. **Обратная совместимость**: Поддерживается для плавного перехода от старой системы

### Рекомендации

1. Регулярно проверяйте роли пользователей
2. Используйте принцип минимальных привилегий
3. Логируйте изменения ролей для аудита
4. Тестируйте авторизацию для всех ролей

## Возможные расширения

1. **Дополнительные роли**: `moderator`, `content_creator`
2. **Разрешения**: Более гранулярный контроль доступа
3. **Временные роли**: Роли с ограниченным сроком действия
4. **Иерархия ролей**: Наследование прав от других ролей 